<%
  english = AnnotatorStore::Language.english
  #languages = [english, AnnotatorStore::UserSetting.language_for_user(current_user)].compact
  languages = AnnotatorStore::Language.all

  resource.names = resource.names.load.select { |n| n.language.in?(languages) }

  languages.each do |language|
    resource.names.build(language: language) unless resource.names.find { |n| n.language == language }
  end

  # Make sure English is always the first language.
  names = (resource.names.first.language == english) ? resource.names : resource.names.reverse
%>


<div class="code-row" id="code-row-<%= resource.id %>">
  <%= form_for(resource, url: annotator_annotator_store_tag_path(resource), html: {class: "form"}, remote: true) do |f| %>
    <% if resource.errors.any? %>
      <div class="error-explanation">
        <h2>
          <%= pluralize(resource.errors.count, "error") %>
          prohibited this code from being saved:
        </h2>

        <ul>
          <% resource.errors.full_messages.each do |message| %>
            <li class="flash-error"><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <table>
      <tr>
        <td class="names">
          <%= f.fields_for :names, names do |ff| %>
            <%= ff.hidden_field :language_id %>
            <div>
              <%= ff.object.language.name %>
              <%= ff.text_field :name %>
            </div>
          <% end %>
        </td>
        <td class="description">
          Code Description
          <%= f.text_area :description, rows: 4 %>
        </td>

        <td class="submit">
          <%= f.submit 'Save' %>
          <% if local_assigns[:saved] %>
            <div class="saved-notification">Saved!</div>
          <% end %>
        </td>
      </tr>
    </table>
  <% end %>


  <% if resource.children.any? %>
    <% resource.children.with_localized_tags(language: AnnotatorStore::UserSetting.language_for_user(current_user)).each do |r| %>
      <%= render 'translate_row', resource: r %>
    <% end %>
  <% end %>
</div>